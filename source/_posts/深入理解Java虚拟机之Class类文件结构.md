---
title: 深入理解Java虚拟机之Class类文件结构
date: 2018-12-07 21:17:08
categories: "深入理解java虚拟机"
tags:
    - JVM
copyright:
---
> Class文件十一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在Class文件之中，当遇到需要占用8位字节以上的空间的数据项时，按照 **高位在前(最高位字节在地址最低位)**的方式分割成若干个8为字节进行存储

Class文件格式：
![](/images/jvm_class_file_format.jpg)

### 1. 魔数与Class文件的版本
- 每个Class文件的头4个字节称为魔数，它的唯一作用是确定这个文件是否为一个能被虚拟机接收的Class文件（很多文件存储标准都是用魔数来进行身份识别，譬如图片格式等）
- 紧接着魔数的4个字节存储的是Class文件的版本号：第5和第6个字节是次版本号，第7和第8个字节是主版本号，高版本的JDK能向下兼容以前版本的Class文件，但不能运行以后版本的Class文件

### 2. 常量池
- 紧接着主次版本号之后的是常量池入口，常量池可以 理解为Class文件之中的资源仓库，常量池的入口需要放置一项u2类型的数据，代表常量池容量计数值，这个计数值从1开始
- 常量池中主要存放两大类常量：字面量和符号引用：
    - 字面量：比较接近于Java语言层面的常量概念
    - 符号引用：属于编译原理方面的概念，包括了下面三类常量：
        - 类和接口的全限定名
        - 字段的名称和描述符
        - 方法的名称和描述符
- 常量池中每一项常量都是一个表，每个表开始的第一位都是一个u1类型的标志位，代表 当前这个常量属于那种类型常量

常量池的项目类型：
![](/images/jvm_class_file_finaltype.jpg)

### 3. 访问标志
- 2个字节，用于标识一些类或者接口层次的访问信息，包括：这个Class是类还是接口，是否定义为public类型，是否为abstract类型等

### 4. 类索引、父类索引与接口索引集合
- Class文件中由这三项数据来确定这个类的继承关系
- 类索引和父类索引引用两个u2类型的索引值表示，他们各自指向一个类型为CONSTANT_Class_info的类描述常量，通过CONSTANT_Class_info类型的常量中的索引值可以找到定义在CONSTANT_Utf8_info类型的常量中的全限定名字符串
- 接口索引集合，入口第一项--u2类型的数据为接口计数器，表示索引表的容量

### 5. 字段表集合
- 用于描述接口或者类中声明的变量
- 字段包括类级变量以及实例级变量，但不包括在方法内部声明的局部变量

### 6. 方法表集合
- Class文件存储格式对方法的描述与对字段的描述几乎采用了完全一致的方式

### 7. 属性表集合
- 在Class文件，字段表、方法表都可以携带自己的属性表集合

